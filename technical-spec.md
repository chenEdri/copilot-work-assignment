# Technical Specification: Priority ERP Integration with Portuguese Tax Authority Transport Documents Web Service

## 1. Introduction

This document outlines the technical specifications for developing a Golang executable that integrates Priority ERP with the Portuguese Tax Authority's (AT) transport documents web service. The primary purpose is to submit waybills (GT - Transport Guide) documents generated by Priority ERP to comply with Portuguese fiscal regulations.

## 2. System Overview

The solution will be a standalone executable file deployed in Priority ERP's directory for executable files. This executable will:

1. Receive XML document body data from Priority ERP as a command-line argument
2. Generate the appropriate SOAP envelope with WS-Security headers
3. Submit the request to the Portuguese Tax Authority web service
4. Log the response to a file
5. Return appropriate exit codes to indicate success or failure

## 3. Technical Requirements

### 3.1 Development Environment

- **Programming Language**: Go (Golang)
- **Build Target**: Executable file (.exe for Windows or appropriate binary for other OS)
- **Deployment Location**: Priority ERP's directory for executable files

### 3.2 Integration Points

#### 3.2.1 Input from Priority ERP
- The XML document body will be passed as a command-line argument
- Authentication credentials will be passed as command-line arguments
- No additional information retrieval from Priority ERP is required

#### 3.2.2 Output to Priority ERP
- Exit code 0 for successful submission
- Exit code 1 for failed submission
- Response from AT will be logged to a file, not returned to Priority ERP

### 3.3 Authentication

#### 3.3.1 Client Certificate
- X.509 certificate in PKCS#12 (.pfx) format
- Located in the same directory as the executable
- TLS 1.2 or higher must be used for all secure connections

#### 3.3.2 WS-Security Headers
- Username format: `{TaxRegistrationNumber}/{BranchID}`
- Password must be encrypted using AES-128 in ECB mode with PKCS7 padding
- Nonce field must contain an RSA-encrypted symmetric key using AT's public certificate
- Created timestamp field must be in ISO-8601 format and encrypted using the same scheme as the password

### 3.4 Service Endpoints

#### 3.4.1 Test Environment (Initial Target)
- URL: `https://servicos.portaldasfinancas.gov.pt:701/sgdtws/documentosTransporte`
- Port: 701

#### 3.4.2 Production Environment (Future Target)
- URL: `https://servicos.portaldasfinancas.gov.pt:401/sgdtws/documentosTransporte`
- Port: 401

## 4. Detailed Design

### 4.1 Application Structure

The executable should follow a clean architecture with the following components:

```
main.go                  # Entry point, command-line parsing
pkg/
  certificate/           # Certificate handling functions
  encryption/            # Encryption utilities for WS-Security
  soap/                  # SOAP envelope generation
  transport/             # HTTP client and request handling
  validation/            # Input validation
```

### 4.2 Command-Line Interface

The executable should accept the following command-line arguments:

```
-xml string              # XML document body (required)
-username string         # Username in format {TaxRegistrationNumber}/{BranchID} (required)
-password string         # Password (required)
-cert string             # Client certificate filename (optional, defaults to "TestesWebServices.pfx" for test)
-certpass string         # Client certificate password (optional)
-output string           # Response output file (optional, defaults to "response.xml")
```

### 4.3 Processing Flow

1. Parse command-line arguments
2. Validate inputs
3. Load client certificate
4. Load AT's public certificate
5. Generate symmetric key for encryption
6. Encrypt password and timestamp using AES-128
7. Encrypt symmetric key using RSA with AT's public certificate
8. Construct WS-Security header
9. Combine header with XML document body to create complete SOAP envelope
10. Submit request to appropriate endpoint
11. Save response to output file
12. Return appropriate exit code

### 4.4 SOAP Envelope Generation

The SOAP envelope should follow this structure:

```xml
<S:Envelope xmlns:S="http://schemas.xmlsoap.org/soap/envelope/">
    <S:Header>
        <wss:Security xmlns:wss="http://schemas.xmlsoap.org/ws/2002/12/secext">
            <wss:UsernameToken>
                <wss:Username>{TaxRegistrationNumber}/{BranchID}</wss:Username>
                <wss:Password>{AES-Encrypted-Password}</wss:Password>
                <wss:Nonce>{RSA-Encrypted-Symmetric-Key}</wss:Nonce>
                <wss:Created>{Encrypted-ISO8601-Timestamp}</wss:Created>
            </wss:UsernameToken>
        </wss:Security>
    </S:Header>
    <S:Body>
        <ns2:envioDocumentoTransporteRequestElem xmlns:ns2="https://servicos.portaldasfinancas.gov.pt/sgdtws/documentosTransporte/">
            <!-- XML document body from Priority ERP -->
        </ns2:envioDocumentoTransporteRequestElem>
    </S:Body>
</S:Envelope>
```

### 4.5 Security Implementation

#### 4.5.1 Password Encryption
- Generate a random 16-byte symmetric key
- Encrypt the password using AES-128 in ECB mode with PKCS7 padding
- Base64 encode the encrypted password

#### 4.5.2 Timestamp Encryption
- Generate an ISO-8601 formatted timestamp (current time)
- Encrypt the timestamp using the same AES-128 key and method
- Base64 encode the encrypted timestamp

#### 4.5.3 Symmetric Key Encryption
- Load AT's public certificate (`ChaveCifraPublicaAT2025.cer`)
- Encrypt the symmetric key using RSA with AT's public key
- Base64 encode the encrypted symmetric key for the Nonce field

### 4.6 HTTP Client Configuration

- Configure HTTP client to use TLS 1.2 or higher
- Set up client certificate authentication
- Set appropriate headers:
  - Content-Type: `text/xml; charset=utf-8`
  - SOAPAction: Empty string (`""`)

### 4.7 Response Handling

- Save the complete HTTP response to the specified output file
- Parse the response to determine success or failure
- Return exit code 0 for success, 1 for failure

## 5. Error Handling

As per requirements, no specific error handling or retry logic is implemented. The application should:

- Exit with code 1 if any errors occur
- Not attempt to retry failed requests
- Not implement any special logging for errors

## 6. Public Certificate Handling

AT's public certificate (`ChaveCifraPublicaAT2025.cer`) should be loaded from a file in the same directory as the executable. This approach allows for easy updates when the certificate is renewed annually.

## 7. Development Considerations

### 7.1 Libraries and Dependencies

The following Go libraries are recommended:

- `crypto/aes` and `crypto/cipher` for AES encryption
- `crypto/rsa` for RSA encryption
- `crypto/x509` for certificate handling
- `encoding/xml` for XML processing
- `net/http` for HTTP client
- `flag` for command-line argument parsing

### 7.2 Security Best Practices

- Never hardcode credentials
- Use secure random number generation for symmetric keys
- Validate all inputs before processing
- Follow best practices for certificate handling

## 8. Testing 

For testing with the AT test environment:
- Username: "770005616/1"
- Password: "T3QDSV54RK9H"
- Certificate: "TestesWebServices.pfx"
- Certificate Password: "TESTEwebservice"

## 9. Deployment

The compiled executable should be placed in Priority ERP's directory for executable files. No additional installation steps are required.

## 10. Performance Considerations

With an expected volume of 20 waybills per day, performance is not a critical concern. However, the application should:

- Complete each submission in a reasonable time (under 10 seconds)
- Release resources properly after each execution
- Minimize memory usage

## 11. Maintenance Considerations

- AT's public certificate is updated annually, so ensure the filename includes the year
- Client certificates may expire and require renewal
- The executable should be designed to accommodate these changes without requiring code modifications
